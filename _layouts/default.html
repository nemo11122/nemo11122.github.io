<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ page.title }} | {{ site.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  {% include header.html %}

  <div class="main-container">
    <main class="posts-area">
      <!-- 🔹 包住頁面內容（搜尋時會隱藏） -->
      <div id="page-content">
        {{ content }}
      </div>

      <!-- 🔍 每一頁都包含搜尋區塊（非常關鍵） -->
      {% include search-block.html %}
    </main>

    {% include sidebar.html %}
  </div>

  {% include footer.html %}

  <!-- 🔍 搜尋功能 JS -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const sidebarInput = document.getElementById("search-input");
      const mainInput = document.getElementById("main-search-input");
      const resultSection = document.getElementById("search-result-section");
      const resultTitle = document.getElementById("search-result-title");
      const resultList = document.getElementById("search-results");
      const homepage = document.getElementById("homepage-posts");
      const contentArea = document.getElementById("page-content");

      let data = [];

      fetch("/search.json")
        .then(res => res.json())
        .then(json => {
          data = json;

          function performSearch(keyword) {
            const q = keyword.trim().toLowerCase();
            if (!q) return;

            if (!resultSection || !resultList || !resultTitle) {
              console.warn("搜尋結果區塊不存在，請確認 layout 有 include search-block.html");
              return;
            }

            if (homepage) homepage.style.display = "none";
            if (contentArea) contentArea.style.display = "none";
            resultSection.style.display = "block";

            resultList.innerHTML = "";
            resultTitle.innerHTML = `Search results for: <mark>${q}</mark>`;
            if (mainInput) mainInput.value = keyword;

            const results = data.filter(post =>
              post.title.toLowerCase().includes(q) ||
              post.excerpt.toLowerCase().includes(q)
            );

            if (results.length === 0) {
              resultList.innerHTML = `
                <div class="search-not-found">
                  <h2>Nothing Found</h2>
                  <p>Try a different keyword.</p>
                </div>`;
              return;
            }

            results.forEach(post => {
              const container = document.createElement("div");
              container.className = "post-item";

              if (post.image) {
                const img = document.createElement("img");
                img.src = post.image;
                img.className = "post-image";
                container.appendChild(img);
              }

              const date = document.createElement("div");
              date.className = "post-date";
              date.textContent = post.date || "";
              container.appendChild(date);

              const title = document.createElement("h2");
              title.className = "post-title";
              const link = document.createElement("a");
              link.href = post.url;
              link.textContent = post.title;
              title.appendChild(link);
              container.appendChild(title);

              const excerpt = document.createElement("div");
              excerpt.className = "post-excerpt";
              excerpt.textContent = post.excerpt;
              container.appendChild(excerpt);

              const readMore = document.createElement("a");
              readMore.href = post.url;
              readMore.textContent = "Continue reading →";
              readMore.className = "read-more";
              container.appendChild(readMore);

              if (post.author) {
                const author = document.createElement("p");
                author.innerHTML = 'Written by <strong>' + post.author + '</strong>';
                author.style.fontSize = "0.9em";
                author.style.color = "#999";
                container.appendChild(author);
              }

              if (post.categories && post.categories.length > 0) {
                const meta = document.createElement("div");
                meta.className = "post-meta-footer";
                meta.innerHTML = "Posted in " + post.categories.map(cat => {
                  return `<a href="/categories/${cat.toLowerCase()}">${cat}</a>`;
                }).join(", ");
                container.appendChild(meta);
              }

              container.appendChild(document.createElement("hr"));
              resultList.appendChild(container);
            });
          }

          if (sidebarInput) {
            sidebarInput.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                e.preventDefault();
                performSearch(this.value);
              }
            });
          }

          if (mainInput) {
            mainInput.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                e.preventDefault();
                performSearch(this.value);
              }
            });
          }

          // 支援網址 query 自動搜尋
          const urlParams = new URLSearchParams(window.location.search);
          const autoQuery = urlParams.get("query");
          if (autoQuery) {
            if (sidebarInput) sidebarInput.value = autoQuery;
            performSearch(autoQuery);
          }
        });
    });
  </script>
</body>
</html>


